name: Build Windows EXE

# Manual trigger only - not on every push
on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      custom_version:
        description: 'Custom version (leave empty for auto-increment)'
        required: false
        default: ''

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all tags
    
    - name: Get latest version and calculate new version
      id: version
      shell: bash
      run: |
        # Get latest tag or default to v0.0.0
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        echo "Latest tag: $LATEST_TAG"
        
        # Remove 'v' prefix
        LATEST_VERSION=${LATEST_TAG#v}
        
        # Parse version components
        IFS='.' read -r MAJOR MINOR PATCH <<< "$LATEST_VERSION"
        MAJOR=${MAJOR:-0}
        MINOR=${MINOR:-0}
        PATCH=${PATCH:-0}
        
        echo "Current version: $MAJOR.$MINOR.$PATCH"
        
        # Check if custom version provided
        if [ -n "${{ github.event.inputs.custom_version }}" ]; then
          NEW_VERSION="${{ github.event.inputs.custom_version }}"
          echo "Using custom version: $NEW_VERSION"
        else
          # Auto-increment based on bump type
          case "${{ github.event.inputs.version_bump }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "Auto-incremented version (${{ github.event.inputs.version_bump }}): $NEW_VERSION"
        fi
        
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "new_tag=v$NEW_VERSION" >> $GITHUB_OUTPUT
        echo ""
        echo "========================================"
        echo "  Building CanOEs v$NEW_VERSION"
        echo "========================================"
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
    
    - name: Build EXE with PyInstaller
      run: |
        pyinstaller --onefile --windowed --name "CanOEs" --icon=NONE --add-data "vn1640a_can.py;." can_gui.py
    
    - name: Create release package
      run: |
        mkdir release
        copy dist\CanOEs.exe release\
        copy README.md release\ 2>nul || echo "No README"
        copy docs\CanOEs_User_Manual.pdf release\ 2>nul || echo "No PDF manual"
      shell: cmd
    
    - name: Upload EXE artifact
      uses: actions/upload-artifact@v4
      with:
        name: CanOEs-${{ steps.version.outputs.new_tag }}-Windows
        path: release/
        retention-days: 90
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.new_tag }}
        name: CanOEs ${{ steps.version.outputs.new_tag }}
        body: |
          ## CanOEs ${{ steps.version.outputs.new_tag }}
          
          CAN/CAN FD communication tool for Vector VN1640A
          
          ### What's New
          - Built from commit: ${{ github.sha }}
          - Build date: ${{ github.event.repository.updated_at }}
          
          ### Downloads
          - `CanOEs.exe` - Standalone Windows executable (no Python required)
          - `CanOEs_User_Manual.pdf` - User documentation
          
          ### Requirements
          - Windows 10/11
          - Vector VN1640A hardware (or compatible VN16xx)
          - Vector XL Driver Library installed
          
          ### Installation
          1. Download `CanOEs.exe`
          2. Run directly - no installation needed
          3. Ensure Vector drivers are installed
        files: |
          release/CanOEs.exe
          release/CanOEs_User_Manual.pdf
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
